{"version":3,"sources":["../src/index.js"],"names":["isMemoryFileSystem","outputFileSystem","constructor","name","userOptions","options","assign","exitOnErrors","force","log","test","useHashIndex","isNull","isRegExp","Error","isBoolean","append","dim","format","assetSourceHashIndex","apply","compiler","outputPath","setupDone","setupStatus","setup","cyan","has","output","path","devServer","plugin","stats","compilation","errors","length","forEach","assets","asset","assetPath","outputFilePath","join","relativeOutputPath","relative","process","cwd","targetDefinition","yellow","assetSize","size","assetSource","source","assetSourceHash","update","digest","green","magenta","sync","dirname","writeFileSync","split"],"mappings":"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","file":"index.js","sourcesContent":["import fs from 'fs';\nimport {\n    createHash\n} from 'crypto';\nimport path from 'path';\nimport _ from 'lodash';\nimport mkdirp from 'mkdirp';\nimport chalk from 'chalk';\nimport moment from 'moment';\nimport filesize from 'filesize';\n\n/**\n * When 'webpack' program is used, constructor name is equal to 'NodeOutputFileSystem'.\n * When 'webpack-dev-server' program is used, constructor name is equal to 'MemoryFileSystem'.\n */\nconst isMemoryFileSystem = (outputFileSystem: Object): boolean => {\n  return outputFileSystem.constructor.name === 'MemoryFileSystem';\n};\n\n/**\n * @property test A regular expression used to test if file should be written. When not present, all bundle will be written.\n * @property useHashIndex Use hash index to write only files that have changed since the last iteration (default: true).\n * @property log Logs names of the files that are being written (or skipped because they have not changed) (default: true).\n * @property exitOnErors Stop writing files on webpack errors (default: true).\n */\ntype UserOptionsType = {\n  exitOnErrors: ?boolean,\n  test: ?RegExp,\n  useHashIndex: ?boolean,\n  log: ?boolean\n};\n\nexport default (userOptions: UserOptionsType = {}): Object => {\n  const options = _.assign({}, {\n    exitOnErrors: true,\n    force: false,\n    log: true,\n    test: null,\n    useHashIndex: true\n  }, userOptions);\n\n  if (!_.isNull(options.test) && !_.isRegExp(options.test)) {\n    throw new Error('options.test value must be an instance of RegExp.');\n  }\n\n  if (!_.isBoolean(options.useHashIndex)) {\n    throw new Error('options.useHashIndex value must be of boolean type.');\n  }\n\n  if (!_.isBoolean(options.log)) {\n    throw new Error('options.log value must be of boolean type.');\n  }\n\n  if (!_.isBoolean(options.exitOnErrors)) {\n    throw new Error('options.exitOnErrors value must be of boolean type.');\n  }\n\n  if (!_.isBoolean(options.force)) {\n    throw new Error('options.force value must be of boolean type.');\n  }\n\n  const log = (...append) => {\n    if (!options.log) {\n      return;\n    }\n\n    // eslint-disable-next-line no-console\n    console.log(chalk.dim('[' + moment().format('HH:mm:ss') + '] [write-file-webpack-plugin]'), ...append);\n  };\n\n  const assetSourceHashIndex = {};\n\n  log('options', options);\n\n  const apply = (compiler) => {\n    let outputPath,\n      setupDone,\n      setupStatus;\n\n    const setup = (): boolean => {\n      if (setupDone) {\n        return setupStatus;\n      }\n\n      setupDone = true;\n\n      log('compiler.outputFileSystem is \"' + chalk.cyan(compiler.outputFileSystem.constructor.name) + '\".');\n\n      if (!isMemoryFileSystem(compiler.outputFileSystem) && !options.force) {\n        return false;\n      }\n\n      // https://github.com/gajus/write-file-webpack-plugin/issues/1\n      // `compiler.options.output.path` will be hardcoded to '/' in\n      // webpack-dev-server's command line wrapper. So it should be\n      // ignored here.\n      if (_.has(compiler, 'options.output.path') && compiler.options.output.path !== '/') {\n        outputPath = compiler.options.output.path;\n      }\n\n      if (!outputPath) {\n        if (!_.has(compiler, 'options.devServer.outputPath')) {\n          throw new Error('output.path is not accessible and devServer.outputPath is not defined. Define devServer.outputPath.');\n        }\n\n        outputPath = compiler.options.devServer.outputPath;\n      }\n\n      log('compiler.options.devServer.outputPath is \"' + chalk.cyan(outputPath) + '\".');\n\n      setupStatus = true;\n\n      return setupStatus;\n    };\n\n    compiler.plugin('done', (stats) => {\n      if (!setup()) {\n        return;\n      }\n\n      if (options.exitOnErrors && stats.compilation.errors.length) {\n        return;\n      }\n\n      log('stats.compilation.errors.length is \"' + chalk.cyan(stats.compilation.errors.length) + '\".');\n\n      _.forEach(stats.compilation.assets, (asset, assetPath) => {\n        const outputFilePath = path.join(outputPath, assetPath);\n        const relativeOutputPath = path.relative(process.cwd(), outputFilePath);\n        const targetDefinition = 'asset: ' + chalk.cyan('./' + assetPath) + '; destination: ' + chalk.cyan('./' + relativeOutputPath);\n\n        if (options.test && !options.test.test(assetPath)) {\n          log(targetDefinition, chalk.yellow('[skipped; does not match test]'));\n\n          return;\n        }\n\n        const assetSize = asset.size();\n        const assetSource = asset.source();\n\n        if (options.useHashIndex) {\n          const assetSourceHash = createHash('sha256').update(assetSource).digest('hex');\n\n          if (assetSourceHashIndex[assetPath] && assetSourceHashIndex[assetPath] === assetSourceHash) {\n            log(targetDefinition, chalk.yellow('[skipped; matched hash index]'));\n\n            return;\n          }\n\n          assetSourceHashIndex[assetPath] = assetSourceHash;\n        }\n\n        log(targetDefinition, chalk.green('[written]'), chalk.magenta('(' + filesize(assetSize) + ')'));\n\n        mkdirp.sync(path.dirname(relativeOutputPath));\n\n        fs.writeFileSync(relativeOutputPath.split('?')[0], assetSource);\n      });\n    });\n  };\n\n  return {\n    apply\n  };\n};\n"]}